name: pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build_docker_image:
    needs: []
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: docker build -t lukasdext01/minha-api:latest .

    - name: Log in to Docker Hub (if needed)
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Docker image to Docker Hub (if needed)
      run: docker push lukasdext01/minha-api:latest


  deploy_to_kubernetes:
          runs-on: ubuntu-latest
          steps:

          - name: code checkout
            uses: actions/checkout@v2

          - name: install the gcloud cli
            uses: google-github-actions/setup-gcloud@v0
            with:
              project_id: ${{ secrets.GOOGLE_PROJECT }}
              service_account_key: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
              install_components: 'gke-gcloud-auth-plugin'
              export_default_credentials: true

          # Configura o contexto do Kubernetes para o cluster desejado
          - name: 'Set Kubernetes Context'
            run: |
              gcloud container clusters get-credentials [YOUR_CLUSTER_NAME] --zone [YOUR_ZONE] --project [YOUR_PROJECT_ID]
          
          # Faz o deploy usando kubectl
          - name: 'Deploy to Kubernetes'
            run: |
              kubectl apply -f deployment.yml
              kubectl apply -f service.yml
      
      
